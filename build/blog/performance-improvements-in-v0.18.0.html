<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Performance Improvements in v0.18.0 | PhoenixSoda</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://jimken-mido.github.io/soda/blog/performance-improvements-in-v0.18.0"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Performance Improvements in v0.18.0 | PhoenixSoda"><meta data-rh="true" name="description" content="We&#x27;ve greatly improved the performance of Phoenix with release v0.18.0. Find out how."><meta data-rh="true" property="og:description" content="We&#x27;ve greatly improved the performance of Phoenix with release v0.18.0. Find out how."><meta data-rh="true" property="og:image" content="https://jimken-mido.github.io/soda/assets/images/final_chart-637212bbabed56e9dd395621f5a4d35d.png"><meta data-rh="true" name="twitter:image" content="https://jimken-mido.github.io/soda/assets/images/final_chart-637212bbabed56e9dd395621f5a4d35d.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-11-01T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/wainwrightmark"><meta data-rh="true" property="article:tag" content="programming,software,performance,C#,csharp,scl,core"><link data-rh="true" rel="icon" href="/soda/img/favicon.png"><link data-rh="true" rel="canonical" href="https://jimken-mido.github.io/soda/blog/performance-improvements-in-v0.18.0"><link data-rh="true" rel="alternate" href="https://jimken-mido.github.io/soda/blog/performance-improvements-in-v0.18.0" hreflang="en"><link data-rh="true" rel="alternate" href="https://jimken-mido.github.io/soda/blog/performance-improvements-in-v0.18.0" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://CKHLUDXFLE-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/soda/blog/rss.xml" title="PhoenixSoda RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/soda/blog/atom.xml" title="PhoenixSoda Atom Feed">
<link rel="alternate" type="application/json" href="/soda/blog/feed.json" title="PhoenixSoda JSON Feed">



<link rel="search" type="application/opensearchdescription+xml" title="PhoenixSoda" href="/soda/opensearch.xml"><link rel="stylesheet" href="/soda/assets/css/styles.29dd6750.css">
<link rel="preload" href="/soda/assets/js/runtime~main.2185a906.js" as="script">
<link rel="preload" href="/soda/assets/js/main.254eb9d2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/soda/"><div class="navbar__logo"><img src="/soda/img/phoenix.svg" alt="Phoenix Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/soda/img/phoenix.svg" alt="Phoenix Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Phoenix</b></a><a class="navbar__item navbar__link" docid="intro" href="/soda/docs/intro">Documentation</a><a class="navbar__item navbar__link" docid="all" href="/soda/steps/all">Steps</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/soda/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link button button-download button--primary button--lg" href="/soda/download">Download</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/soda/docs/intro">v0.18.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/soda/docs/next/intro">v0.19.0-alpha üöß</a></li><li><a class="dropdown__link" href="/soda/docs/intro">v0.18.0</a></li><li><a class="dropdown__link" href="/soda/docs/v0.17.0/intro">v0.17.0</a></li><li><a class="dropdown__link" href="/soda/docs/v0.16.0/intro">v0.16.0</a></li></ul></div><a href="https://gitlab.com/Phoenix" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-gitlab-link" aria-label="GitLab Repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/soda/blog/performance-improvements-in-v0.18.0">Performance Improvements in v0.18.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/soda/blog/wrangling-dates-with-scl">Wrangling Dates with SCL</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="We&#x27;ve greatly improved the performance of Phoenix with release v0.18.0. Find out how."><link itemprop="image" href="https://jimken-mido.github.io/soda/assets/images/final_chart-637212bbabed56e9dd395621f5a4d35d.png"><header><h1 class="title_f1Hy" itemprop="headline">Performance Improvements in v0.18.0</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-11-01T00:00:00.000Z" itemprop="datePublished">November 1, 2022</time> ¬∑ <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/wainwrightmark" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/5428904?s=400&amp;u=272a94528302c122cfe8964069c86b65dd406645&amp;v=4" alt="Mark Wainwright" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/wainwrightmark" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Mark Wainwright</span></a></div><small class="avatar__subtitle" itemprop="description">Phoenix Maintainer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>The focus for Phoenix release v0.18.0 has been on performance.
This post explains the changes we&#x27;ve made,
how they&#x27;ve improved performance, and why we decided to implement them.
This is aimed at both <em>SCL</em> users and <em>C#</em> developers who are interested in performance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-scl">What is SCL<a href="#what-is-scl" class="hash-link" aria-label="Direct link to What is SCL" title="Direct link to What is SCL">‚Äã</a></h2><p>Phoenix Configuration Language (SCL) is a programming language for forensic and ediscovery technicians.
The typical use case involves reading, writing, and manipulating large amounts of data so performance is critical.
The language is implemented in <em>C#</em> so performance improvements are achieved by optimizing <em>C#</em> code.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="measuring-performance">Measuring Performance<a href="#measuring-performance" class="hash-link" aria-label="Direct link to Measuring Performance" title="Direct link to Measuring Performance">‚Äã</a></h2><p>Before we improve performance we need to measure it. This means benchmarking.
I created a new console project and added the excellent
<a href="https://benchmarkdotnet.org/articles/overview.html" target="_blank" rel="noopener noreferrer">benchmark dot net</a> package to it.</p><p>As we want to optimize real world performance I found some real world data to run the benchmarks on.
This data is a 1MB concordance file (very similar to a CSV) with 1000 rows and 44 columns.
The data comes from the <em>ENRON</em> dataset but nevertheless I was very careful to add it to
<code>.gitignore</code> and not commit it to the open source repository.</p><p>I wrote several <em>SCL</em> scripts representing different workflows.
For example this script removes a column from the data:</p><div class="language-scl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token sclVariable builtin" style="color:rgb(0, 112, 193)">&lt;path&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token stepName class-name" style="color:rgb(38, 127, 153)">PathCombine</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;Data&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;TestData.dat&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain"> </span><span class="token stepName class-name" style="color:rgb(38, 127, 153)">FileRead</span><span class="token plain"> </span><span class="token sclVariable builtin" style="color:rgb(0, 112, 193)">&lt;path&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token stepName class-name" style="color:rgb(38, 127, 153)">FromConcordance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token stepName class-name" style="color:rgb(38, 127, 153)">EntityMap</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token stepName class-name" style="color:rgb(38, 127, 153)">EntityRemoveProperty</span><span class="token plain">  </span><span class="token sclVariable builtin" style="color:rgb(0, 112, 193)">&lt;&gt;</span><span class="token plain"> </span><span class="token stepParameter function" style="color:rgb(0, 0, 255)">Property</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Custodian&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token stepName class-name" style="color:rgb(38, 127, 153)">ToConcordance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token stepName class-name" style="color:rgb(38, 127, 153)">StringLength</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that <code>StringLength</code> at the end. This is to ensure that the stream of concordance data
is read to the end (and therefore all of the data is converted to concordance).
In a real world scenario one would probably write the data to a file or send it across
the internet but doing that would make the benchmarks a lot more fiddly and
the code that writes to a file is outside my control anyway so there is not much point in benchmarking it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarks">Benchmarks<a href="#benchmarks" class="hash-link" aria-label="Direct link to Benchmarks" title="Direct link to Benchmarks">‚Äã</a></h2><p>Here is a summary of all the benchmarks and the initial results, running on a 12th gen Intel i7 CPU on <em>Windows</em>.</p><table><thead><tr><th align="left"><strong>Name</strong></th><th align="left"><strong>Summary</strong></th><th align="center"><strong>Mean / Œºs</strong></th><th align="center"><strong>Error / Œºs</strong></th><th align="center"><strong>Standard Deviation / Œºs</strong></th></tr></thead><tbody><tr><td align="left">BasicSCL</td><td align="left">Prints &#x27;Hello World&#x27;</td><td align="center">68.11</td><td align="center">1.327</td><td align="center">1.363</td></tr><tr><td align="left">CombineColumns</td><td align="left">Reads a concordance file, adds a new column by combining two existing ones, and converts it back to concordance</td><td align="center">306,342.04</td><td align="center">2,856.823</td><td align="center">2,385.576</td></tr><tr><td align="left">ConvertDates</td><td align="left">Reads a concordance file, converts dates to a different representation, and converts it back to concordance</td><td align="center">121,637.43</td><td align="center">1,641.555</td><td align="center">1,535.512</td></tr><tr><td align="left">DatToDat</td><td align="left">Reads a concordance file, and converts it back to concordance</td><td align="center">92,824.18</td><td align="center">810.059</td><td align="center">718.096</td></tr><tr><td align="left">DatToJson</td><td align="left">Reads a concordance file, and converts it json</td><td align="center">86,831.86</td><td align="center">1,723.177</td><td align="center">2,471.330</td></tr><tr><td align="left">JsonToDat</td><td align="left">Reads a json file and converts it to concordance</td><td align="center">74,657.57</td><td align="center">1,249.805</td><td align="center">1,169.068</td></tr><tr><td align="left">RemapColumns</td><td align="left">Reads a concordance file, renames one of the columns, and converts it back to concordance</td><td align="center">98,585.92</td><td align="center">1,902.414</td><td align="center">2,035.561</td></tr><tr><td align="left">RemoveColumn</td><td align="left">Reads a concordance file, removes one of the columns, and converts it back to concordance</td><td align="center">149,538.83</td><td align="center">1,581.342</td><td align="center">1,479.188</td></tr><tr><td align="left">SchemaValidate</td><td align="left">Reads a concordance file, confirms that all rows conform to a particular json schema, and converts it back to concordance</td><td align="center">133,736.27</td><td align="center">793.008</td><td align="center">702.981</td></tr><tr><td align="left">StringReplace</td><td align="left">Reads a concordance file, performs some string replacements on each row, and converts it to json</td><td align="center">335,875.11</td><td align="center">4,519.005</td><td align="center">4,227.080</td></tr></tbody></table><p>Note that all times are in microseconds, so the longest Phoenixs are taking about one third of a second.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance-improvements">Performance Improvements<a href="#performance-improvements" class="hash-link" aria-label="Direct link to Performance Improvements" title="Direct link to Performance Improvements">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="replacing-task-with-valuetask">Replacing <code>Task</code> with <code>ValueTask</code><a href="#replacing-task-with-valuetask" class="hash-link" aria-label="Direct link to replacing-task-with-valuetask" title="Direct link to replacing-task-with-valuetask">‚Äã</a></h3><p><em>SCL</em> steps all have a <code>Run</code> method which returns the result wrapped in a <code>Task</code>.
One of the performance optimizations I was eager to try was wrapping the result in a <code>ValueTask</code> instead.
This should reduce the number of heap allocations per step by one and
I was expecting a small performance improvement for Phoenixs which run cheap steps inside a loop.</p><p>The tradeoff is that there are some things you can do with a <code>Task</code> but not with a <code>ValueTask</code>
such as awaiting them multiple times. Fortunately the <code>Run</code> method was only being used
in a few places and I was able to easily check that none of the missing functionality was being used.</p><p>The results of this update:</p><table><thead><tr><th align="left"><strong>Name</strong></th><th align="center"><strong>Initial / Œºs</strong></th><th align="center"><strong>After ValueTask / Œºs</strong></th><th align="center"><strong>Ratio</strong></th></tr></thead><tbody><tr><td align="left">BasicSCL</td><td align="center">68.11</td><td align="center">64.56</td><td align="center">0.947878432</td></tr><tr><td align="left">CombineColumns</td><td align="center">306,342.04</td><td align="center">306,125.29</td><td align="center">0.999292458</td></tr><tr><td align="left">ConvertDates</td><td align="center">121,637.43</td><td align="center">120,553.24</td><td align="center">0.991086707</td></tr><tr><td align="left">DatToDat</td><td align="center">92,824.18</td><td align="center">93,733.29</td><td align="center">1.009793892</td></tr><tr><td align="left">DatToJson</td><td align="center">86,831.86</td><td align="center">86,622.87</td><td align="center">0.997593165</td></tr><tr><td align="left">JsonToDat</td><td align="center">74,657.57</td><td align="center">74,910.93</td><td align="center">1.003393628</td></tr><tr><td align="left">RemapColumns</td><td align="center">98,585.92</td><td align="center">98,365.44</td><td align="center">0.997763575</td></tr><tr><td align="left">RemoveColumn</td><td align="center">149,538.83</td><td align="center">148,584.52</td><td align="center">0.993618313</td></tr><tr><td align="left">SchemaValidate</td><td align="center">133,736.27</td><td align="center">131,679.90</td><td align="center">0.984623693</td></tr><tr><td align="left">StringReplace</td><td align="center">335,875.11</td><td align="center">328,927.93</td><td align="center">0.979316181</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="finding-a-bug">Finding a Bug<a href="#finding-a-bug" class="hash-link" aria-label="Direct link to Finding a Bug" title="Direct link to Finding a Bug">‚Äã</a></h3><p>A 2% performance improvement on the slowest benchmark was nice but I was actually
hoping for a larger improvement. The StringReplace Phoenix was taking about three
times as long as the ConvertDates Phoenix despite doing what seemed like a lot less work.</p><p>I thought that the reason might be that <code>StringReplace</code> converts the data at the end
into JSON rather that concordance like most of the other benchmarks.
I chose to do this initially because I wanted to make sure that performing an action
on the data first didn&#x27;t make the conversion to JSON slower.
At this stage I wrote additional benchmarks to check if that was what was happening.
It wasn&#x27;t - converting to JSON was consistently ~6000Œºs faster than converting to
concordance across the board.</p><p>Thinking again, I thought the difference might be down to the fixed cost of running a step.
ConvertDates uses the <code>Transform</code> step which applies a JSON schema to every step in
an entity stream whereas StringReplace is using the <code>ArrayMap</code> step to call the
<code>StringReplace</code> step on every entity in the stream.
This means that the StringReplace Phoenix is running about 1000 very cheap steps
where ConvertDates is calling one very expensive step.</p><p>I decided to use the Visual Studio performance profiler to try and find out what was going on.
I stared by using the CPU usage tool as I thought the CPU was the most likely performance bottleneck.</p><p>I discovered that a lot of time was being spent in the <code>IRunnableStep&lt;T&gt;.Run</code> method.
This is not unexpected but what was unexpected was that it was spending almost three
times as long in there as in the <code>CompoundStep&lt;T&gt;.Run</code> method despite it having been
designed as a thin wrapper around that method which exists purely to enable logging.</p><p>Looking at the method code I immediately spotted the problem:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:rgb(38, 127, 153)">Task</span><span class="token return-type class-name punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token return-type class-name" style="color:rgb(38, 127, 153)">Result</span><span class="token return-type class-name punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token return-type class-name" style="color:rgb(38, 127, 153)">T</span><span class="token return-type class-name punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token return-type class-name" style="color:rgb(38, 127, 153)"> IError</span><span class="token return-type class-name punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token return-type class-name punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"> IRunnableStep</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">T</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">Run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token class-name" style="color:rgb(38, 127, 153)">IStateMonad</span><span class="token plain"> stateMonad</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(38, 127, 153)">CancellationToken</span><span class="token plain"> cancellationToken</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">stateMonad</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">Logger</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">BeginScope</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token return-type class-name keyword" style="color:rgb(0, 0, 255)">object</span><span class="token return-type class-name punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token return-type class-name punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">GetEnterStepArgs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(0, 0, 255)">var</span><span class="token plain"> properties </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> AllProperties</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">ToDictionary</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">x </span><span class="token operator" style="color:rgb(0, 0, 0)">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(0, 0, 0)">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">Serialize</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">SerializeOptions</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">SanitizedName</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token keyword" style="color:rgb(0, 0, 255)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:rgb(0, 0, 255)">object</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token constructor-invocation class-name punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> Name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> properties </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        LogSituation</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">EnterStep</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">Log</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">stateMonad</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">this</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">GetEnterStepArgs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token class-name keyword" style="color:rgb(0, 0, 255)">var</span><span class="token plain"> result </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">Run</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">stateMonad</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> cancellationToken</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">IsFailure</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            LogSituation</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">ExitStepFailure</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">Log</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">stateMonad</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">this</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> Name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">AsString</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token keyword" style="color:rgb(0, 0, 255)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token class-name keyword" style="color:rgb(0, 0, 255)">var</span><span class="token plain"> resultValue </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">Serialize</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">SerializeOptions</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">SanitizedName</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            LogSituation</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">ExitStepSuccess</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token function" style="color:rgb(0, 0, 255)">Log</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">stateMonad</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">this</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> Name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> resultValue</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token keyword" style="color:rgb(0, 0, 255)">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The EnterStep arguments are being created - using an expensive dictionary - every time the step is run,
regardless of the logging level (they should only be logged if the log level is <code>Trace</code> and the benchmarks are using <code>Info</code>).
Clearly what happened was that the <code>LogSituation.EnterStep.Log</code> method once took a <code>Func&lt;object[]&gt;</code>
but was refactored to use an <code>object[]</code> at some point and I missed the performance implications
when updating this invocation.</p><p>I fixed the code and also checked other invocations of the method to make sure I wasn&#x27;t
making the same mistake somewhere else (I wasn&#x27;t). Then I ran the benchmarks again:</p><table><thead><tr><th align="left"><strong>Name</strong></th><th align="center"><strong>After ValueTask</strong></th><th align="center"><strong>After EnterStep Fix</strong></th><th align="center"><strong>Ratio</strong></th></tr></thead><tbody><tr><td align="left">BasicSCL</td><td align="center">64.56</td><td align="center">35.39</td><td align="center">0.548172243</td></tr><tr><td align="left">CombineColumns</td><td align="center">306,125.29</td><td align="center">103,820.13</td><td align="center">0.339142611</td></tr><tr><td align="left">ConvertDates</td><td align="center">120,553.24</td><td align="center">119,108.53</td><td align="center">0.988016</td></tr><tr><td align="left">DatToDat</td><td align="center">93,733.29</td><td align="center">92,621.39</td><td align="center">0.988137619</td></tr><tr><td align="left">DatToJson</td><td align="center">86,622.87</td><td align="center">86,615.62</td><td align="center">0.999916304</td></tr><tr><td align="left">JsonToDat</td><td align="center">74,910.93</td><td align="center">77,218.89</td><td align="center">1.030809389</td></tr><tr><td align="left">RemapColumns</td><td align="center">98,365.44</td><td align="center">97,755.47</td><td align="center">0.99379894</td></tr><tr><td align="left">RemoveColumn</td><td align="center">148,584.52</td><td align="center">98,192.86</td><td align="center">0.660855249</td></tr><tr><td align="left">SchemaValidate</td><td align="center">131,679.90</td><td align="center">131,270.77</td><td align="center">0.996892996</td></tr><tr><td align="left">StringReplace</td><td align="center">328,927.93</td><td align="center">95,778.85</td><td align="center">0.291184911</td></tr></tbody></table><p>The three benchmarks which run steps in a loop all got a lot faster, and the BasicSCL Phoenix
got almost twice as fast. This just goes to show that finding and fixing performance bugs
is often massively more effective than micro-optimizing heap allocations.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rearchitecting-entities">Rearchitecting Entities<a href="#rearchitecting-entities" class="hash-link" aria-label="Direct link to Rearchitecting Entities" title="Direct link to Rearchitecting Entities">‚Äã</a></h3><p>The other way to get big performance wins is to use the right collections in the right
places. <em>SCL</em> has the type <code>entity</code> which is used to represent data. It&#x27;s a key-value or
property-value container, similar to a javascript object. The most obvious way to represent
this in C# was to use a <code>Dictionary&lt;String, Object&gt;</code> and that was essentially how the <code>Entity</code> type was
implemented - though using the SCL-friendly types <code>StringStream</code> and <code>ISCLObject</code> instead.
I wanted to try a different implementation using two <code>ImmutableArray</code>s instead.
<code>ImmutableArray</code> is an extremely thin wrapper around an array and has exactly the same performance characteristics.</p><p>I refactored the <code>entity</code> type to use an <code>ImmutableArray&lt;StringStream&gt;</code> for the property names
and <code>ImmutableArray&lt;ISCLObject&gt;</code> for the values. I made them private to ensure that they would
always be kept in sync. I updated the implementations of all the <code>entity</code> methods but not the signatures.
Keeping the interface the same meant that the refactor was very smooth and I hardly had to
change any code outside the <code>entity</code> class.</p><p>Making this change also allowed me to sneak in a few other performance optimizations.
When creating entities from a consistent data structure (such as a CSV file or a SQL table)
I could let all the entities share the same headers collection.
Note that this would have been a bad idea if I had used a regular rather than immutable array.</p><p>I ran the benchmarks again and compared to the previous results:</p><table><thead><tr><th align="left"><strong>Name</strong></th><th align="center"><strong>After EnterStep fix</strong></th><th align="center"><strong>After Entity Refactor</strong></th><th align="center"><strong>Change</strong></th></tr></thead><tbody><tr><td align="left">BasicSCL</td><td align="center">35.39</td><td align="center">35.81</td><td align="center">1.011867759</td></tr><tr><td align="left">CombineColumns</td><td align="center">103,820.13</td><td align="center">70,840.40</td><td align="center">0.682337809</td></tr><tr><td align="left">ConvertDates</td><td align="center">119,108.53</td><td align="center">62,156.69</td><td align="center">0.521849191</td></tr><tr><td align="left">DatToDat</td><td align="center">92,621.39</td><td align="center">61,528.62</td><td align="center">0.66430249</td></tr><tr><td align="left">DatToJson</td><td align="center">86,615.62</td><td align="center">41,558.64</td><td align="center">0.479805375</td></tr><tr><td align="left">JsonToDat</td><td align="center">77,218.89</td><td align="center">50,542.41</td><td align="center">0.654534273</td></tr><tr><td align="left">RemapColumns</td><td align="center">97,755.47</td><td align="center">60,397.03</td><td align="center">0.617837856</td></tr><tr><td align="left">RemoveColumn</td><td align="center">98,192.86</td><td align="center">62,817.56</td><td align="center">0.639736535</td></tr><tr><td align="left">SchemaValidate</td><td align="center">131,270.77</td><td align="center">104,101.35</td><td align="center">0.793027648</td></tr><tr><td align="left">StringReplace</td><td align="center">95,778.85</td><td align="center">52,792.74</td><td align="center">0.551194131</td></tr></tbody></table><p>This change almost ‚ùó <strong>doubled</strong> ‚ùó performance across the board
(note that the BasicSCL Phoenix does not use entities). I was very happy.</p><p>The table and charts below show the complete journey.
Some of the steps were now several times as fast and this difference would likely be
magnified in real world scenarios that perform multiple transformations since
the costs of reading the file and converting between data formats are fixed.</p><table><thead><tr><th align="left"><strong>Name</strong></th><th align="center"><strong>Initial</strong></th><th align="center"><strong>After ValueTask</strong></th><th align="center"><strong>Change</strong></th><th align="center"><strong>After EnterStep fix</strong></th><th align="center"><strong>Change</strong></th><th align="center"><strong>After Entity Refactor</strong></th><th align="center"><strong>Change</strong></th><th align="center"><strong>Total Change</strong></th></tr></thead><tbody><tr><td align="left">BasicSCL</td><td align="center">68.11</td><td align="center">64.56</td><td align="center">0.947878432</td><td align="center">35.39</td><td align="center">0.548172243</td><td align="center">35.81</td><td align="center">1.011867759</td><td align="center">0.525767141</td></tr><tr><td align="left">CombineColumns</td><td align="center">306,342.04</td><td align="center">306,125.29</td><td align="center">0.999292458</td><td align="center">103,820.13</td><td align="center">0.339142611</td><td align="center">70,840.40</td><td align="center">0.682337809</td><td align="center">0.231246093</td></tr><tr><td align="left">ConvertDates</td><td align="center">121,637.43</td><td align="center">120,553.24</td><td align="center">0.991086707</td><td align="center">119,108.53</td><td align="center">0.988016</td><td align="center">62,156.69</td><td align="center">0.521849191</td><td align="center">0.510999698</td></tr><tr><td align="left">DatToDat</td><td align="center">92,824.18</td><td align="center">93,733.29</td><td align="center">1.009793892</td><td align="center">92,621.39</td><td align="center">0.988137619</td><td align="center">61,528.62</td><td align="center">0.66430249</td><td align="center">0.66285121</td></tr><tr><td align="left">DatToJson</td><td align="center">86,831.86</td><td align="center">86,622.87</td><td align="center">0.997593165</td><td align="center">86,615.62</td><td align="center">0.999916304</td><td align="center">41,558.64</td><td align="center">0.479805375</td><td align="center">0.478610501</td></tr><tr><td align="left">JsonToDat</td><td align="center">74,657.57</td><td align="center">74,910.93</td><td align="center">1.003393628</td><td align="center">77,218.89</td><td align="center">1.030809389</td><td align="center">50,542.41</td><td align="center">0.654534273</td><td align="center">0.676989755</td></tr><tr><td align="left">RemapColumns</td><td align="center">98,585.92</td><td align="center">98,365.44</td><td align="center">0.997763575</td><td align="center">97,755.47</td><td align="center">0.99379894</td><td align="center">60,397.03</td><td align="center">0.617837856</td><td align="center">0.612633427</td></tr><tr><td align="left">RemoveColumn</td><td align="center">149,538.83</td><td align="center">148,584.52</td><td align="center">0.993618313</td><td align="center">98,192.86</td><td align="center">0.660855249</td><td align="center">62,817.56</td><td align="center">0.639736535</td><td align="center">0.420075241</td></tr><tr><td align="left">SchemaValidate</td><td align="center">133,736.27</td><td align="center">131,679.90</td><td align="center">0.984623693</td><td align="center">131,270.77</td><td align="center">0.996892996</td><td align="center">104,101.35</td><td align="center">0.793027648</td><td align="center">0.778407757</td></tr><tr><td align="left">StringReplace</td><td align="center">335,875.11</td><td align="center">328,927.93</td><td align="center">0.979316181</td><td align="center">95,778.85</td><td align="center">0.291184911</td><td align="center">52,792.74</td><td align="center">0.551194131</td><td align="center">0.157179673</td></tr></tbody></table><p><img loading="lazy" alt="Performance Improvement Benchmarks" src="/soda/assets/images/final_chart-637212bbabed56e9dd395621f5a4d35d.png" width="1653" height="993" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="takeaways">Takeaways<a href="#takeaways" class="hash-link" aria-label="Direct link to Takeaways" title="Direct link to Takeaways">‚Äã</a></h2><p>The top takeaways from this project are:</p><ul><li>Fixing bugs is often the best way to improve performance</li><li>Dictionaries are slow - plain old arrays are often faster even when
a <code>Dictionary</code> or <code>Hashmap</code> is the &quot;theoretically&quot; correct choice.</li><li>Refactoring can be easier than you expect, especially if the code you
are changing is well insulated and the API to that code remains consistent.</li></ul><p>One final thing - even though the <code>ValueTask</code> update only showed a very small improvement initially,
that improvement was orthogonal to the other improvements. It shaved 5ms off the initial StringReplace
benchmark and once I had completed the other improvements I tried reverting just the <code>ValueTask</code>
changes and running the benchmarks again.
StringReplace was now about 5ms slower. Had I done this change last instead of first it would
have looked like an 8% improvement instead of a 2% one.
This shows the value of <strong>small incremental improvements</strong>.
Sometimes they don&#x27;t just add up - they multiply!</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/soda/blog/tags/programming">programming</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/soda/blog/tags/software">software</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/soda/blog/tags/performance">performance</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/soda/blog/tags/c">C#</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/soda/blog/tags/csharp">csharp</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/soda/blog/tags/scl">scl</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/soda/blog/tags/core">core</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/jimken-mido/soda/blog/20221101-performance-improvements/performance_improvements.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/soda/blog/wrangling-dates-with-scl"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Wrangling Dates with SCL</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-scl" class="table-of-contents__link toc-highlight">What is SCL</a></li><li><a href="#measuring-performance" class="table-of-contents__link toc-highlight">Measuring Performance</a></li><li><a href="#benchmarks" class="table-of-contents__link toc-highlight">Benchmarks</a></li><li><a href="#performance-improvements" class="table-of-contents__link toc-highlight">Performance Improvements</a><ul><li><a href="#replacing-task-with-valuetask" class="table-of-contents__link toc-highlight">Replacing <code>Task</code> with <code>ValueTask</code></a></li><li><a href="#finding-a-bug" class="table-of-contents__link toc-highlight">Finding a Bug</a></li><li><a href="#rearchitecting-entities" class="table-of-contents__link toc-highlight">Rearchitecting Entities</a></li></ul></li><li><a href="#takeaways" class="table-of-contents__link toc-highlight">Takeaways</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Lorem</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/soda/docs/quick-start#connectors">Ting</a></li></ul></div><div class="col footer__col"><div class="footer__title">Ipsum</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://gitlab.com/Phoenix" target="_blank" rel="noopener noreferrer" class="footer__link-item">Check out the Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Dolor</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/soda/search">Search</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬©2025 LoremIpsum. Built with <a href="https://docusaurus.io" target="_blank" rel="noopener">Docusaurus</a>.</div></div></div></footer></div>
<script src="/soda/assets/js/runtime~main.2185a906.js"></script>
<script src="/soda/assets/js/main.254eb9d2.js"></script>
</body>
</html>